# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —á–∞—Ç–æ–≤ - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞–º–∏ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π —Ñ–∞–π–ª–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –Ω–∞ R2.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏

- **–°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞**: –ö–Ω–æ–ø–∫–∞ "+ –ù–æ–≤—ã–π —á–∞—Ç" –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
- **–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤**: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏**: –ö–ª–∏–∫ –ø–æ —á–∞—Ç—É –≤ —Å–ø–∏—Å–∫–µ
- **–£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞**: –ö–Ω–æ–ø–∫–∞ "üóë –£–¥–∞–ª–∏—Ç—å" (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)

### 2. –ü—Ä–∏–≤—è–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –∫ —á–∞—Ç–∞–º

- –í—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
- –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —á–∞—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ–≥–æ —Ñ–∞–π–ª—ã
- –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î (`qa_conversation_gemini_files`)

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ R2

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è:
```
chats/
  {conversation_id}/
    messages.json          # –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏
    files/
      {filename1}          # –ö–æ–ø–∏–∏ —Ñ–∞–π–ª–æ–≤ —á–∞—Ç–∞
      {filename2}
```

### 4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:
- –ù–∞–∑–≤–∞–Ω–∏–µ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

## Workflow

### –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–∞–±–æ—Ç–∞ —Å —á–∞—Ç–æ–º

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "+ –ù–æ–≤—ã–π —á–∞—Ç"
2. –í–≤–æ–¥–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞
3. –ß–∞—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
4. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –∏–∑ –¥–µ—Ä–µ–≤–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
5. –§–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ —á–∞—Ç—É
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã
7. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ R2

### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —á–∞—Ç –≤ —Å–ø–∏—Å–∫–µ
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î
3. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —á–∞—Ç—É
4. –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ UI

### –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —á–∞—Ç –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "üóë –£–¥–∞–ª–∏—Ç—å"
2. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ
3. –£–¥–∞–ª—è—é—Ç—Å—è:
   - –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
   - –°–≤—è–∑–∏ —Å —Ñ–∞–π–ª–∞–º–∏
   - –ü–∞–ø–∫–∞ –Ω–∞ R2
   - –°–∞–º —á–∞—Ç

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–±–ª–µ–º–∞ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –¥–µ–ª–∞–ª–∞ 1 + (N √ó 2) –∑–∞–ø—Ä–æ—Å–æ–≤
- –î–ª—è 50 —á–∞—Ç–æ–≤ = 101 –∑–∞–ø—Ä–æ—Å (~10-15 —Å–µ–∫—É–Ω–¥)

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RPC —Ñ—É–Ω–∫—Ü–∏–∏ —Å JOIN
- –î–ª—è 50 —á–∞—Ç–æ–≤ = 1 –∑–∞–ø—Ä–æ—Å (~100ms)

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–ó–∞–ø—É—Å—Ç–∏—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞ `002_qa_list_conversations_rpc.sql` –≤ Supabase SQL Editor.

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ù–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã:
- `qa_conversations` - —á–∞—Ç—ã
- `qa_messages` - —Å–æ–æ–±—â–µ–Ω–∏—è
- `qa_conversation_gemini_files` - —Å–≤—è–∑—å —á–∞—Ç-—Ñ–∞–π–ª—ã
- `qa_gemini_files` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤ Gemini

### –ù–æ–≤—ã–µ –º–æ–¥–µ–ª–∏

**schemas.py:**
- `ConversationWithStats` - —á–∞—Ç —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

**supabase_repo.py:**
- `qa_list_conversations()` - —Å–ø–∏—Å–æ–∫ —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
- `qa_get_conversation()` - –ø–æ–ª—É—á–∏—Ç—å —á–∞—Ç
- `qa_update_conversation()` - –æ–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç
- `qa_delete_conversation()` - —É–¥–∞–ª–∏—Ç—å —á–∞—Ç
- `qa_get_conversation_files()` - —Ñ–∞–π–ª—ã —á–∞—Ç–∞

### –ú–µ—Ç–æ–¥—ã R2

**r2_async.py:**
- `save_chat_messages()` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É
- `load_chat_messages()` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É
- `save_chat_file()` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É —á–∞—Ç–∞
- `delete_chat_folder()` - —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É —á–∞—Ç–∞

### UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**right_context_panel.py:**
- –í–∫–ª–∞–¥–∫–∞ "üí¨ –ß–∞—Ç—ã"
- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**main_window.py:**
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —á–∞—Ç–æ–≤
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. Fallback —Ä–µ–∂–∏–º –±–µ–∑ RPC —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Ç–æ–≤
2. –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã –∏–∑ Gemini Files API (—Ç–æ–ª—å–∫–æ —Å–≤—è–∑–∏)
3. –õ–∏–º–∏—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è - 50 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —á–∞—Ç–æ–≤

## Roadmap

- [ ] –ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º
- [ ] –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç —á–∞—Ç–æ–≤
- [ ] –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —á–∞—Ç–æ–≤
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–∞—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
- [ ] –¢–µ–≥–∏ –¥–ª—è —á–∞—Ç–æ–≤
